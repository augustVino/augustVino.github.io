(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{677:function(t,a,n){"use strict";n.r(a);var e=n(59),s=Object(e.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"h5-页面唤起微信支付并签约"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#h5-页面唤起微信支付并签约"}},[t._v("#")]),t._v(" H5 页面唤起微信支付并签约")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),n("p",[t._v("本文档只是本人公司项目实践总结，不同公司开发逻辑可能有些许不同，但流程基本相同。")])]),t._v(" "),n("p",[n("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信H5支付并签约官方文档"),n("OutboundLink")],1)]),t._v(" "),n("h2",{attrs:{id:"需求描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#需求描述"}},[t._v("#")]),t._v(" 需求描述")]),t._v(" "),n("p",[t._v("手机自带浏览器（或其他第三方浏览器），打开商品详情页面")]),t._v(" "),n("p",[n("strong",[t._v("----\x3e")]),t._v(" 点击"),n("strong",[t._v("购买按钮")]),t._v("进入订单结算页面")]),t._v(" "),n("p",[n("strong",[t._v("----\x3e")]),t._v(" 点击"),n("strong",[t._v("确认支付")]),t._v("按钮唤起微信app并完成支付")]),t._v(" "),n("p",[n("strong",[t._v("----\x3e")]),t._v(" 支付完成后跳转回原浏览器，并展示相应的支付结果（成功 or 失败）。")]),t._v(" "),n("h2",{attrs:{id:"技术分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#技术分析"}},[t._v("#")]),t._v(" 技术分析")]),t._v(" "),n("table",[n("tr",[n("td",[n("center",[n("img",{attrs:{src:"/img/pay6.1-1.webp"}}),t._v("图1 商品详情页面")])],1),t._v(" "),n("td",[n("center",[n("img",{attrs:{src:"/img/pay6.1-2.webp"}}),t._v("图2 订单结算页面")])],1),t._v(" "),n("td",[n("center",[n("img",{attrs:{src:"/img/pay6.1-3.webp"}}),t._v("图3 微信app支付")])],1)])]),t._v(" "),n("ol",[n("li",[n("p",[t._v("在"),n("strong",[t._v("商品详情")]),t._v("页面，点击 "),n("strong",[n("code",[t._v("￥19")])]),t._v(" 购买按钮，通过"),n("code",[t._v("location.href")]),t._v("跳转到"),n("strong",[t._v("订单结算")]),t._v("页（并把商品信息传递过去）。")])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("订单结算")]),t._v("页面初始化时：")]),t._v(" "),n("ul",[n("li",[t._v("获取接收传递过来的商品信息("),n("code",[t._v("info")]),t._v(")；")]),t._v(" "),n("li",[t._v("用"),n("code",[t._v("info")]),t._v("调接口，创建订单、并获取订单号("),n("code",[t._v("orderId")]),t._v(")；")])])]),t._v(" "),n("li",[n("p",[t._v("点击"),n("strong",[t._v("订单结算")]),t._v("页面的"),n("strong",[t._v("确认支付")]),t._v("按钮：")]),t._v(" "),n("ul",[n("li",[t._v("通过"),n("code",[t._v("orderId")]),t._v("和支付方式("),n("code",[t._v("wxH5Pay")]),t._v(")调接口，获取支付跳转url("),n("code",[t._v("mwap_url")]),t._v(")，接口返回数据如下："),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"systemDate"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1566871733530")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"status"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"code"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"systemDate"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1566871733530"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"currentDate"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-08-27 10:08:53"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mwap_url"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx271008534967979d0db4082f1542937200&package=3013834615"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-74978"}},[t._v("copy success")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'{\n    "systemDate": 1566871733530,\n    "status": {\n        "code": 0\n    },\n    "data": {\n        "systemDate": "1566871733530",\n        "currentDate": "2019-08-27 10:08:53",\n        "mwap_url": "https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx271008534967979d0db4082f1542937200&package=3013834615"\n    }\n}\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-74978","data-mdic-notify-delay":"2000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("copy")])]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-39914"}},[t._v("Copy successed")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'{\n    "systemDate": 1566871733530,\n    "status": {\n        "code": 0\n    },\n    "data": {\n        "systemDate": "1566871733530",\n        "currentDate": "2019-08-27 10:08:53",\n        "mwap_url": "https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx271008534967979d0db4082f1542937200&package=3013834615"\n    }\n}\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-39914","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"Copy failed",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("Copy")])])])])]),t._v(" "),n("li",[t._v("分端处理唤起微信app：\n"),n("ul",[n("li",[t._v("客户端"),n("code",[t._v("webview")]),t._v("内嵌h5："),n("div",{staticClass:"language-vue extra-class"},[n("pre",{pre:!0,attrs:{class:"language-vue"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- vue --\x3e")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("iframe")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("myframe"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-if")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("terminal=='ddandroid'"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("height")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("width")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("frameborder")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":src")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("iframe")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...调接口获取mwap_url")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mwap_url "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&redirect_url="')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("locationUrl "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&wechatH5=1&orderIdFromWechat="')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-79754"}},[t._v("copy success")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'\x3c!-- vue --\x3e\n<iframe\n    id="myframe"\n    v-if="terminal==\'ddandroid\'"\n    height="0"\n    width="0"\n    frameborder="0"\n    :src="url"\n></iframe>\n<script>\n    // ...调接口获取mwap_url\n\n    // locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）\n    this.url = mwap_url + "&redirect_url=" + encodeURIComponent(locationUrl + "&wechatH5=1&orderIdFromWechat=" + this.orderNo);\n<\/script>\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-79754","data-mdic-notify-delay":"2000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("copy")])]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-76083"}},[t._v("Copy successed")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'\x3c!-- vue --\x3e\n<iframe\n    id="myframe"\n    v-if="terminal==\'ddandroid\'"\n    height="0"\n    width="0"\n    frameborder="0"\n    :src="url"\n></iframe>\n<script>\n    // ...调接口获取mwap_url\n\n    // locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）\n    this.url = mwap_url + "&redirect_url=" + encodeURIComponent(locationUrl + "&wechatH5=1&orderIdFromWechat=" + this.orderNo);\n<\/script>\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-76083","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"Copy failed",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("Copy")])])])])]),t._v(" "),n("li",[t._v("系统自带浏览器（包含部分第三方浏览器）："),n("div",{staticClass:"language-vue extra-class"},[n("pre",{pre:!0,attrs:{class:"language-vue"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- vue --\x3e")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 调接口前,创建一个空窗口")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" blankLink "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"about:blank"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 调接口获取mwap_url")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 为新窗口添加链接")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）")]),t._v("\n    blankLink"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mwap_url "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&redirect_url="')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("locationUrl "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&wechatH5=1&orderIdFromWechat="')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("orderNo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-75365"}},[t._v("copy success")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'\x3c!-- vue --\x3e\n\n<script>\n    // 1. 调接口前,创建一个空窗口\n    let blankLink = window.open("about:blank");\n\n    // 2. 调接口获取mwap_url\n    // ...省略\n\n    // 3. 为新窗口添加链接\n    // locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）\n    blankLink.location = mwap_url +"&redirect_url=" +encodeURIComponent(locationUrl + "&wechatH5=1&orderIdFromWechat=" + this.orderNo);\n<\/script>\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-75365","data-mdic-notify-delay":"2000","data-mdic-copy-fail-text":"copy fail",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("copy")])]),n("div",{pre:!0,attrs:{class:"m-mdic-copy-wrapper"}},[n("div",{pre:!0,attrs:{class:"u-mdic-copy-notify",id:"j-notify-1589775700990-35140"}},[t._v("Copy successed")]),n("button",{pre:!0,attrs:{class:"u-mdic-copy-btn j-mdic-copy-btn","data-mdic-content":'\x3c!-- vue --\x3e\n\n<script>\n    // 1. 调接口前,创建一个空窗口\n    let blankLink = window.open("about:blank");\n\n    // 2. 调接口获取mwap_url\n    // ...省略\n\n    // 3. 为新窗口添加链接\n    // locationUrl 为支付完成后重定向的页面链接（本项目仍跳转回订单结算页，后边分析）\n    blankLink.location = mwap_url +"&redirect_url=" +encodeURIComponent(locationUrl + "&wechatH5=1&orderIdFromWechat=" + this.orderNo);\n<\/script>\n',"data-mdic-attach-content":"","data-mdic-notify-id":"j-notify-1589775700990-35140","data-mdic-notify-delay":"1000","data-mdic-copy-fail-text":"Copy failed",onclick:"!function(t){const e={copy:(t='',e='')=>new Promise((c,o)=>{const n=document.createElement('textarea'),d=e?`\\n\\n${e}`:e;n.value=`${t}${d}`,document.body.appendChild(n),n.select();try{const t=document.execCommand('copy');document.body.removeChild(n),t?c():o()}catch(t){document.body.removeChild(n),o()}}),btnClick(t){const c=t&&t.dataset?t.dataset:{},o=c.mdicNotifyId,n=document.getElementById(o),d=c.mdicNotifyDelay,i=c.mdicCopyFailText;e.copy(c.mdicContent,c.mdicAttachContent).then(()=>{n.style.display='block',setTimeout(()=>{n.style.display='none'},d)}).catch(()=>{alert(i)})}};e.btnClick(t)}(this);"}},[t._v("Copy")])])])])])])])]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信H5支付"),n("OutboundLink")],1),t._v("官方文档中明确表示："),n("strong",[t._v("H5支付不能直接在微信客户端内调起，请在外部浏览器调起")]),t._v(",故此处若是微信内部浏览器打开结算页面点击确认支付按钮，直接引导到外部浏览器打开页面，如下图。")])]),t._v(" "),n("image-image",{attrs:{imgSrc:"/img/pay6.1-4.webp",imgAlt:"pay6.1-4"}})],1),t._v(" "),n("li",[n("p",[t._v("在第3步中唤起微信app时，在重定向url（"),n("code",[t._v("redirect_url")]),t._v("）中多传递了两个参数："),n("code",[t._v("wechatH5=1")]),t._v("和"),n("code",[t._v("orderIdFromWechat")]),t._v("。这两个参数并不是微信官方要求的，而是项目需要。原因如下：")])])]),t._v(" "),n("p",[t._v("上边说了"),n("code",[t._v("redirect_url")]),t._v("是微信支付完成后的重定向url，这个"),n("strong",[t._v("支付完成")]),t._v("只是说的微信app支付完成了（成功或失败），并"),n("strong",[t._v("不代表")]),t._v("微信app支付完成"),n("strong",[t._v("商户")]),t._v("就会立即收到钱，中间肯定有延时。所以我在重定向到订单结算页时多传递了两个参数（"),n("code",[t._v("wechatH5=1")]),t._v("表示是h5唤起微信支付;"),n("code",[t._v("orderIdFromWechat")]),t._v("表示当前支付的订单号,也就是"),n("code",[t._v("orderId")]),t._v("）。")]),t._v(" "),n("p",[t._v("当订单结算页初始化时，我会获取url中是否有"),n("code",[t._v("wechatH5=1")]),t._v("和"),n("code",[t._v("orderIdFromWechat")]),t._v("这两个参数。如果有，说明是支付完成重定向后的页面，此时我会直接展示loading，同时用订单号("),n("code",[t._v("orderIdFromWechat")]),t._v(")"),n("strong",[t._v("轮询")]),t._v("调接口（此处3秒调一次，最多15次，第15次返回失败的话直接跳转支付失败页面）获取订单状态，以确认是否支付成功。")]),t._v(" "),n("star-star"),t._v(" "),n("comment-comment"),t._v(" "),n("back-to-top")],1)}),[],!1,null,null,null);a.default=s.exports}}]);